<div class="drp4">
  <div class="field">
    <div class="fieldLabel">Date range</div>

    <button
      type="button"
      class="selectTrigger"
      (click)="toggleOpen()"
      [attr.aria-expanded]="isOpen()"
    >
      <span class="triggerText" *ngIf="triggerLabel(); else placeholder">
        {{ triggerLabel() }}
      </span>
      <ng-template #placeholder>
        <span class="placeholder">{{ placeholderText() }}</span>
      </ng-template>

      <span class="caret" aria-hidden="true">▾</span>
    </button>

    <div class="helperText" *ngIf="dateRangeMessage()">
      {{ dateRangeMessage() }}
    </div>
  </div>

  <!-- Panel -->
  <div class="panel" *ngIf="isOpen()">
    <div class="panelGrid" [class.noPresets]="!isPremium">
      <!-- Left presets (Premium only) -->
      <aside class="presetPane" *ngIf="isPremium">
        <div class="presetTitle">Select range</div>

        <div class="presetList">
          <button
            *ngFor="let p of visiblePresets()"
            type="button"
            class="presetBtn"
            [class.selected]="activePresetKey() === p.key"
            (click)="selectPreset(p.key)"
          >
            {{ p.label }}
          </button>
        </div>
      </aside>

      <!-- Right side: inputs + calendars + footer -->
      <section class="mainPane">
        <div class="panelTop">
          <div class="inputs">
            <!-- Start date input -->
            <div class="field">
              <div class="fieldLabel">Start date</div>
              <input
                readonly
                [class.active]="activeField() === 'start'"
                [class.invalid]="showError() && !draft().start"
                [value]="draft().start ? (draft().start | date:'MM/dd/yyyy') : ''"
                placeholder="MM/DD/YYYY"
                (click)="setActive('start')"
              />
              <div class="fieldError" *ngIf="showError() && !draft().start">
                Please select a start date.
              </div>
            </div>

            <!-- End date input -->
            <div class="field">
              <div class="fieldLabel">End date</div>
              <input
                readonly
                [class.active]="activeField() === 'end'"
                [class.invalid]="showError() && !draft().end"
                [value]="draft().end ? (draft().end | date:'MM/dd/yyyy') : ''"
                placeholder="MM/DD/YYYY"
                (click)="setActive('end')"
              />
              <div class="fieldError" *ngIf="showError() && !draft().end">
                Please select an end date.
              </div>
            </div>
          </div>
        </div>

        <div class="calStack">
          <!-- TOP calendar -->
          <div class="cal">
            <div class="calHeader">
              <button class="iconBtn" type="button" (click)="prevMonth('top')" aria-label="Previous month">
                ←
              </button>

              <div class="headerCenter">
                <div class="pickerWrap">
                  <button type="button" class="pickerBtn" (click)="toggleMonthPicker('top')" [class.open]="isMonthPickerOpen('top')">
                    {{ monthFullLabel(topMonthIndex()) }}
                    <span class="caret">▾</span>
                  </button>

                  <div class="pickerPopover" *ngIf="isMonthPickerOpen('top')" (mousedown)="$event.stopPropagation()">
                    <div class="pickerTitle">Month</div>
                    <div class="pickerGrid">
                      <button
                        type="button"
                        class="pickerCell"
                        *ngFor="let m of monthsShort; let i = index"
                        [disabled]="isFutureMonth('top', i, topYearValue())"
                        [class.selected]="i === topMonthIndex()"
                        (click)="pickMonth('top', i)"
                      >
                        {{ m }}
                      </button>
                    </div>
                  </div>
                </div>

                <div class="pickerWrap">
                  <button type="button" class="pickerBtn" (click)="toggleYearPicker('top')" [class.open]="isYearPickerOpen('top')">
                    {{ topYearValue() }}
                    <span class="caret">▾</span>
                  </button>

                  <div class="pickerPopover year" *ngIf="isYearPickerOpen('top')" (mousedown)="$event.stopPropagation()">
                    <div class="pickerTitle">Year</div>
                    <div class="yearScroll" (wheel)="onYearWheel('top', $event)">
                      <div class="pickerGrid">
                        <button
                          type="button"
                          class="pickerCell"
                          *ngFor="let y of yearsForEndYear(yearPageEnd('top'))"
                          [disabled]="isYearOptionDisabled('top', y)"
                          [class.selected]="y === topYearValue()"
                          (click)="pickYear('top', y)"
                        >
                          {{ y }}
                        </button>
                      </div>
                                          </div>
                  </div>
                </div>
              </div>

              <span class="iconSpacer" aria-hidden="true"></span>
            </div>
            <div class="calMonthLabel">{{ label(topMonth()) }}</div>

            <div class="dow">
              <div class="dowCell" *ngFor="let d of dow">{{ d }}</div>
            </div>

            <div class="grid">
              <ng-container *ngFor="let cell of topGrid()">
                <div *ngIf="cell === null" class="cell empty"></div>
                <button
                  *ngIf="cell !== null"
                  type="button"
                  class="cell"
                  [class.inRange]="inRange(cell)"
                  [class.start]="isStart(cell)"
                  [class.end]="isEnd(cell)"
                  [class.disabledCell]="isCellDisabled(cell)"
                  [disabled]="isCellDisabled(cell)"
                  (click)="pickDate(cell)"
                >
                  {{ cell.getDate() }}
                  <span class="todayDot" *ngIf="isToday(cell)"></span>
                </button>
              </ng-container>
            </div>
          </div>

          <!-- BOTTOM calendar -->
          <div class="cal">
            <div class="calHeader">
              <span class="iconSpacer" aria-hidden="true"></span>

              <div class="headerCenter">
                <div class="pickerWrap">
                  <button type="button" class="pickerBtn" (click)="toggleMonthPicker('bottom')" [class.open]="isMonthPickerOpen('bottom')">
                    {{ monthFullLabel(bottomMonthIndex()) }}
                    <span class="caret">▾</span>
                  </button>

                  <div class="pickerPopover" *ngIf="isMonthPickerOpen('bottom')" (mousedown)="$event.stopPropagation()">
                    <div class="pickerTitle">Month</div>
                    <div class="pickerGrid">
                      <button
                        type="button"
                        class="pickerCell"
                        *ngFor="let m of monthsShort; let i = index"
                        [disabled]="isFutureMonth('bottom', i, bottomYearValue())"
                        [class.selected]="i === bottomMonthIndex()"
                        (click)="pickMonth('bottom', i)"
                      >
                        {{ m }}
                      </button>
                    </div>
                  </div>
                </div>

                <div class="pickerWrap">
                  <button type="button" class="pickerBtn" (click)="toggleYearPicker('bottom')" [class.open]="isYearPickerOpen('bottom')">
                    {{ bottomYearValue() }}
                    <span class="caret">▾</span>
                  </button>

                  <div class="pickerPopover year" *ngIf="isYearPickerOpen('bottom')" (mousedown)="$event.stopPropagation()">
                    <div class="pickerTitle">Year</div>
                    <div class="yearScroll" (wheel)="onYearWheel('bottom', $event)">
                      <div class="pickerGrid">
                        <button
                          type="button"
                          class="pickerCell"
                          *ngFor="let y of yearsForEndYear(yearPageEnd('bottom'))"
                          [disabled]="isYearOptionDisabled('bottom', y)"
                          [class.selected]="y === bottomYearValue()"
                          (click)="pickYear('bottom', y)"
                        >
                          {{ y }}
                        </button>
                      </div>
                                          </div>
                  </div>
                </div>
              </div>

              <button class="iconBtn" type="button" (click)="nextMonth('bottom')" [disabled]="!canGoNext('bottom')" aria-label="Next month">
                →
              </button>
            </div>
            <div class="calMonthLabel">{{ label(bottomMonth()) }}</div>

            <div class="dow">
              <div class="dowCell" *ngFor="let d of dow">{{ d }}</div>
            </div>

            <div class="grid">
              <ng-container *ngFor="let cell of bottomGrid()">
                <div *ngIf="cell === null" class="cell empty"></div>
                <button
                  *ngIf="cell !== null"
                  type="button"
                  class="cell"
                  [class.inRange]="inRange(cell)"
                  [class.start]="isStart(cell)"
                  [class.end]="isEnd(cell)"
                  [class.disabledCell]="isCellDisabled(cell)"
                  [disabled]="isCellDisabled(cell)"
                  (click)="pickDate(cell)"
                >
                  {{ cell.getDate() }}
                  <span class="todayDot" *ngIf="isToday(cell)"></span>
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="footer">
          <button class="btn ghost" type="button" (click)="closePanel()">Close</button>

          <div class="footerRight">
            <span class="rangeLimitWarning" *ngIf="rangeTooLarge()">{{ rangeTooLargeMessage() }}</span>

            <button class="btn ghost" type="button" (click)="clearDraft()">{{ isPremium ? 'Reset' : 'Clear' }}</button>

            <div class="applyWrap">
  <button
    class="btn"
    type="button"
    (click)="apply()"
    [disabled]="!canApply()"
    [class.disabledBtn]="!canApply()"
  >
    Apply
  </button>

  <div class="applyTooltip" *ngIf="applyTooltipText()">
    {{ applyTooltipText() }}
  </div>
</div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

